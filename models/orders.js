const mongoose = require('mongoose');
const { Schema } = mongoose;

const OrderSchema = new Schema({
    // 1. Order Number: unique & generated by pre-save hook
    orderNumber: { 
        type: String, 
        unique: true, 
        sparse: true // ğŸš€ Ø§Ù„ØªØµØ­ÙŠØ­ 1: ÙŠØ³Ù…Ø­ Ø¨ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© null ÙÙŠ Ù…Ø³ØªÙ†Ø¯ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
    },

    user: { type: Schema.Types.ObjectId, ref: 'User', required: true },

    items: [
        {
            product: { type: Schema.Types.ObjectId, ref: 'Product', required: true },
            name: { type: String, required: true }, 
            quantity: { type: Number, required: true, min: 1 },
            price: { type: Number, required: true }, // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø°ÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            // ğŸš€ Ø§Ù„ØªØµØ­ÙŠØ­ 2: Ø¬Ø¹Ù„ 'condition' ØºÙŠØ± Ù…Ø·Ù„ÙˆØ¨ (Ù„ÙŠØ³ required) Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚
            condition: { type: String, enum: ['New', 'Used', 'Imported'] } 
        }
    ],

    // 2. ğŸš€ Ø§Ù„ØªØµØ­ÙŠØ­ 3: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© Ù„Ù€ Schema
    totalAmount: { type: Number, required: true },
    VAT: { type: Number, default: 0 },
    deliveryFee: { type: Number, default: 0 },
    discount: { type: Number, default: 0 },

    paymentMethod: { type: String, enum: ['COD', 'Online'], required: true },
    paymentStatus: { type: String, enum: ['Pending', 'Paid', 'Refunded'], default: 'Pending' },

    // Shipping Address
    shippingAddress: {
        address: String,
        city: String,
        postalCode: String,
        country: String,
        phone: String
    },

    // Order Status Stages (ÙƒÙ…Ø§ Ù‡ÙŠ)
    orderStatus: { 
        type: String, 
        enum: [
            'Order Placed', 'Payment Confirmed', 'Shipped', 
            'Out for Delivery', 'Delivered', 'Cancelled', 'Returned'
        ], 
        default: 'Order Placed' 
    },

    // Tracking & Dates (ÙƒÙ…Ø§ Ù‡ÙŠ)
    estimatedDeliveryDate: Date,
    actualDeliveryDate: Date,
    trackingNumber: String,

    // Cancellation Logic (ÙƒÙ…Ø§ Ù‡ÙŠ)
    isCancelled: { type: Boolean, default: false },
    cancellationReason: { 
        type: String, 
        enum: ['Changed my mind', 'Found better price', 'Ordered by mistake', 'Shipping takes too long', 'Other'] 
    },
    cancellationDate: Date,

    // Return Logic (ÙƒÙ…Ø§ Ù‡ÙŠ)
    isReturnRequested: { type: Boolean, default: false },
    returnDetails: {
        reason: { 
            type: String, 
            enum: ['Product defective/damaged', 'Wrong item received', 'Product doesn\'t match description', 'Missing accessories/parts'] 
        },
        comment: String,
        proofImages: [String], 
        requestDate: Date,
        status: {
            type: String,
            enum: ['None', 'Return Requested', 'Return Approved', 'Return Rejected', 'Item Picked Up', 'Item Received', 'Quality Check', 'Refund Processed'],
            default: 'None'
        }
    }

}, { timestamps: true });

// Auto-generate Order Number (ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ±ÙŠØ¯Ø©)



module.exports = mongoose.model('Order', OrderSchema);